---
phase: 06-safety-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/templates/state.md
  - get-shit-done/references/state-schema.md
  - commands/gsd/rollback-phase.md
  - get-shit-done/workflows/execute-plan.md
autonomous: true

must_haves:
  truths:
    - "Phase start commits are recorded in STATE.md when first task commits"
    - "/gsd:rollback-phase {N} reverts all commits in phase N"
    - "Rollback cleans up phase planning files"
    - "Rollback is blocked during active execution"
  artifacts:
    - path: "commands/gsd/rollback-phase.md"
      provides: "Rollback command"
      contains: "git revert"
    - path: "get-shit-done/templates/state.md"
      provides: "Phase Commits section template"
      contains: "## Phase Commits"
    - path: "get-shit-done/references/state-schema.md"
      provides: "Schema for Phase Commits section"
      contains: "phase_commits"
  key_links:
    - from: "commands/gsd/rollback-phase.md"
      to: ".planning/STATE.md"
      via: "grep for phase commit hash"
      pattern: "grep.*Phase Commits"
    - from: "get-shit-done/workflows/execute-plan.md"
      to: ".planning/STATE.md"
      via: "record phase commit after first task"
      pattern: "Phase Commits"
---

<objective>
Implement phase commit recording and rollback mechanism for safer autonomous operation.

Purpose: Enable reverting all commits in a phase when verification fails or user requests rollback. This provides a safety net for autonomous execution -- if things go wrong, everything can be cleanly undone.

Output: `/gsd:rollback-phase` command and phase commit tracking in STATE.md
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-safety-features/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase Commits tracking to STATE.md infrastructure</name>
  <files>
    get-shit-done/templates/state.md
    get-shit-done/references/state-schema.md
    get-shit-done/workflows/execute-plan.md
  </files>
  <action>
1. Update `get-shit-done/templates/state.md`:
   - Add "## Phase Commits" section between "Session Continuity" and end of template
   - Include table structure: `| Phase | First Commit | Phase Directory | Recorded |`
   - Add section documentation explaining purpose

2. Update `get-shit-done/references/state-schema.md`:
   - Add `phase_commits` to schema definition
   - Define as optional section (not all projects will have phase commits yet)
   - Specify table columns and data types

3. Update `get-shit-done/workflows/execute-plan.md`:
   - In `task_commit` step (or after first task commit), add logic to record phase commit
   - Check if Phase Commits section exists, create if not
   - Check if phase already recorded, skip if so
   - Append row: `| {PHASE} | {COMMIT_HASH:0:7} | {PHASE_DIR} | {DATE} |`
   - Use bash pattern from research: `grep -q "| ${PHASE} |"` to check existing

Recording trigger: After first task commit in a plan (when TASK_NUMBER is 1 and plan is first in phase).
  </action>
  <verify>
    - Templates contain Phase Commits section
    - Schema includes phase_commits definition
    - execute-plan.md has commit recording logic
  </verify>
  <done>
    STATE.md template has Phase Commits table, schema defines it, execute-plan records commits after first task of each phase
  </done>
</task>

<task type="auto">
  <name>Task 2: Create /gsd:rollback-phase command</name>
  <files>
    commands/gsd/rollback-phase.md
  </files>
  <action>
Create `commands/gsd/rollback-phase.md` with:

1. **Frontmatter:**
   - name: gsd:rollback-phase
   - description: Revert all commits in a phase
   - argument-hint: "<phase-number>"
   - allowed-tools: Read, Bash, Write, AskUserQuestion

2. **Process:**
   a. Validate phase exists in Phase Commits table:
      ```bash
      PHASE_START=$(grep "| ${PHASE} |" .planning/STATE.md | awk -F'|' '{gsub(/ /,"",$3); print $3}')
      ```
      If empty: error "No commit recorded for phase ${PHASE}"

   b. Check execution status in STATE.md:
      - If Status contains "In progress": error "Cannot rollback during active execution"

   c. Count commits in range:
      ```bash
      COMMIT_COUNT=$(git rev-list --count ${PHASE_START}^..HEAD)
      ```

   d. Present confirmation (using AskUserQuestion):
      - Show commit count, phase name, commits to revert
      - Options: "Proceed with rollback", "Cancel"

   e. Execute rollback:
      ```bash
      git revert --no-commit ${PHASE_START}^..HEAD
      git commit -m "revert: rollback phase ${PHASE}"
      ```

   f. Clean up planning files:
      - Delete phase directory: `rm -rf .planning/phases/${PHASE}-*/`
      - Remove phase from Phase Commits table in STATE.md
      - Update Current Position to previous phase
      - Update progress bar

   g. Update ROADMAP.md:
      - Mark phase as "Rolled back" or remove completion marker

3. **Error handling:**
   - Uncommitted changes: error with message to commit or stash first
   - Merge conflicts during revert: accept "theirs" strategy, or error with guidance

4. **Success output:**
   ```
   Phase {N} rolled back successfully.
   {X} commits reverted.
   Planning files cleaned up.

   Current position: Phase {N-1} complete
   ```
  </action>
  <verify>
    - File exists at commands/gsd/rollback-phase.md
    - Contains frontmatter with required fields
    - Process includes validation, confirmation, revert, cleanup steps
    - Error handling for common failure modes
  </verify>
  <done>
    /gsd:rollback-phase command exists with full validation, confirmation, revert, and cleanup logic
  </done>
</task>

</tasks>

<verification>
- [ ] `get-shit-done/templates/state.md` contains Phase Commits section
- [ ] `get-shit-done/references/state-schema.md` includes phase_commits in schema
- [ ] `get-shit-done/workflows/execute-plan.md` records phase commit after first task
- [ ] `commands/gsd/rollback-phase.md` exists with complete implementation
- [ ] Rollback validates phase exists, blocks during execution, confirms with user
- [ ] Rollback uses git revert (not reset), cleans up planning files, updates state
</verification>

<success_criteria>
FEAT-01 complete:
- Phase start commits are recorded in STATE.md
- `/gsd:rollback-phase {N}` reverts all commits in phase N
- Rollback cleans up phase planning files
- Rollback is blocked during active execution
- User confirmation required before destructive action
</success_criteria>

<output>
After completion, create `.planning/phases/06-safety-features/06-01-SUMMARY.md`
</output>
